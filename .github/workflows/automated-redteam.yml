name: Automated Red Team Attack Run

on:
  # Run every Monday at 00:00 UTC (Sunday 7pm EST)
  schedule:
    - cron: '0 0 * * 1'
  
  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      mode:
        description: 'Execution mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - category
          - chains
      category:
        description: 'Category (for category mode: PI, JB, DE, PE, OM, DOS)'
        required: false
        type: string
      targets:
        description: 'Target models (space-separated: azure-openai claude)'
        required: false
        default: 'azure-openai claude'
        type: string

jobs:
  red-team-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: üîß Checkout Repository
        uses: actions/checkout@v4
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install Dependencies
        run: |
          pip install --upgrade pip
          pip install python-dotenv anthropic openai azure-search-documents
          pip install langchain langgraph langchain-anthropic langchain-openai
      
      - name: ‚öôÔ∏è Setup Environment
        env:
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "AZURE_OPENAI_API_KEY=$AZURE_OPENAI_API_KEY" >> .env
          echo "AZURE_OPENAI_ENDPOINT=$AZURE_OPENAI_ENDPOINT" >> .env
          echo "AZURE_OPENAI_DEPLOYMENT=$AZURE_OPENAI_DEPLOYMENT" >> .env
          echo "AZURE_OPENAI_API_VERSION=$AZURE_OPENAI_API_VERSION" >> .env
          echo "ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY" >> .env
      
      - name: üéØ Run Red Team Attack Simulator
        id: attack_run
        env:
          MODE: ${{ github.event.inputs.mode || 'full' }}
          CATEGORY: ${{ github.event.inputs.category || '' }}
          TARGETS: ${{ github.event.inputs.targets || 'azure-openai claude' }}
        run: |
          echo "üî• RED TEAM ATTACK SIMULATOR - AUTOMATED RUN"
          echo "================================================"
          echo "Mode: $MODE"
          echo "Targets: $TARGETS"
          echo "Triggered by: ${{ github.event_name }}"
          echo ""
          
          # Build command based on mode
          if [ "$MODE" = "category" ] && [ -n "$CATEGORY" ]; then
            python automated_run.py --mode category --category "$CATEGORY" --targets $TARGETS
          elif [ "$MODE" = "chains" ]; then
            python automated_run.py --mode chains --targets $TARGETS
          else
            python automated_run.py --mode "$MODE" --targets $TARGETS
          fi
          
          # Capture exit code for notifications
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Exit with the actual code
          exit $EXIT_CODE
      
      - name: üìä Generate Dashboard
        if: always()
        run: |
          echo "üìä Generating dashboard..."
          python generate_dashboard.py -o docs/
          echo "‚úÖ Dashboard generated at docs/index.html"
      
      - name: üì§ Commit and Push Results
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "Red Team Bot"
          
          # Add results and dashboard
          git add results/attack_log.json results/automated_run_summary.json docs/index.html
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "ü§ñ Automated red team run - $TIMESTAMP"
            git push
            echo "‚úÖ Results pushed to repository"
          fi
      
      - name: üì¢ Send Success Notification
        if: success() && steps.attack_run.outputs.exit_code == '0'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            python notify.py --status success --file results/automated_run_summary.json
          fi
      
      - name: üö® Send Critical Alert
        if: success() && steps.attack_run.outputs.exit_code == '1'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            python notify.py --status critical --file results/automated_run_summary.json
          fi
      
      - name: ‚ùå Send Failure Notification
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            python notify.py --status failure --message "Red team run failed. Check workflow logs."
          fi
      
      - name: üìù Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: red-team-results-${{ github.run_number }}
          path: |
            results/attack_log.json
            results/automated_run_summary.json
            docs/index.html
          retention-days: 90

# Security: Restrict permissions
permissions:
  contents: write  # Need write for committing results
  actions: read
